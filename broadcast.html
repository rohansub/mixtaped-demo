<!DOCTYPE html>
<html>

<head>
	<title>Mixtaped</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="styles/main.css">
</head>

<body>
	<header>
        <img src="styles/Blue Mixtaped Logo with TM.svg" alt="Mixtaped" style="width:225px;height:225px;">
        <nav>
            <ul>
                <li><a href="#">Home</a></li>
                <li><a href="#">Subscriptions</a></li>
                <li><a href="#">Trending</a></li>
                <!-- <li><a href="#">My Streams</a></li> -->
				<li><a href="broadcast">Stream Now</a></li>
                <li><a href="#">Genres</a></li>
            </ul>
        </nav>
    </header>
	<h2>You are now broadcasting. Do not refresh the page.</h2>
	<div class="hero_video_container">
		<video id="cast_video_local"></video>
	</div>

	<div id="comment_input">
		<label>Name:</label>
		<input id="comment_input_name" type="text">
		<br>
		<label>Message:</label>
		<textarea id="comment_input_text"></textarea>
		<button onclick="onCommentSubmit()">Send</button>
	</div>
	<div id="comment_collection">
		
	</div>
</body>

<script src="lib/simplewebrtc.bundle.js"></script>
<script>
	// create our webrtc connection
	var webrtc = new SimpleWebRTC({
		// the id/element dom element that will hold "our" video
		localVideoEl: "cast_video_local",
		// the id/element dom element that will hold remote videos
		remoteVideosEl: "",
		// immediately ask for camera access
		autoRequestMedia: true,

		receiveMedia: {
			offerToReceiveAudio: false,
			offerToReceiveVideo: false
		},

		media: {
			video: true,
			audio: true
		},

		debug: false,
		detectSpeakingEvents: true
	});

	// when it is ready, join room "main"
	webrtc.on("readyToCall", function() {
		console.log("readyToCall");

		webrtc.joinRoom("main");
	});

	webrtc.on("channelMessage", function(peer, label, data) {
		if (label == "hark") return true;
		console.log("channelMessage", peer, label, data);

		if (data.type == "chat" && data.payload.room == webrtc.connection.getSessionid()) {
			if (data.payload.id == null)  // Beautify hash
				data.payload.id = peer.id.replace("-", "").toLowerCase().substring(0, 7);
			showComment(data.payload);
		}
	});

	function onCommentSubmit() {
		var input = document.getElementById("comment_input_name");
		var textarea = document.getElementById("comment_input_text");
		var data = { user: input.value, id: "host", room: webrtc.connection.getSessionid(), text: textarea.value, time: new Date().toString()};
		webrtc.sendDirectlyToAll('meta', 'chat', data);

		showComment(data);
		
		textarea.value = "";
	}

	function showComment(data) {
		var container = document.createElement("div");

		var user = document.createElement("p");
		user.appendChild(document.createTextNode(data.user + "(" + data.id + ")" + " at " + data.time));
		container.appendChild(user);
		var text = document.createElement("p");
		text.appendChild(document.createTextNode(data.text));
		container.appendChild(text);

		var comments = document.getElementById("comment_collection");
		comments.appendChild(container);
	}
</script>

</html>
